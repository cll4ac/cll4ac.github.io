<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>redis/Redis学习笔记（二） | Sky</title><meta name="description" content="redis/Redis学习笔记（二）"><meta name="author" content="cll4ac"><meta name="copyright" content="cll4ac"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="redis/Redis学习笔记（二）"><meta name="twitter:description" content="redis/Redis学习笔记（二）"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="redis/Redis学习笔记（二）"><meta property="og:url" content="http://yoursite.com/2020/08/04/redis/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/"><meta property="og:site_name" content="Sky"><meta property="og:description" content="redis/Redis学习笔记（二）"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/08/04/redis/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/"><link rel="next" title="redis/Redis学习笔记（一）" href="http://yoursite.com/2020/08/04/redis/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://cll4ac.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Sky</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">11</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Redis学习笔记（二）"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Redis学习笔记（二）</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#一、Redis持久化"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">一、Redis持久化</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1、RDB"><span class="toc_mobile_items-number">1.1.1.</span> <span class="toc_mobile_items-text">1、RDB</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-RDB介绍"><span class="toc_mobile_items-number">1.1.1.1.</span> <span class="toc_mobile_items-text">1.1 RDB介绍</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-2-RDB的工作方式"><span class="toc_mobile_items-number">1.1.1.2.</span> <span class="toc_mobile_items-text">1.2 RDB的工作方式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-3-RDB的优点"><span class="toc_mobile_items-number">1.1.1.3.</span> <span class="toc_mobile_items-text">1.3 RDB的优点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-4-RDB的缺点"><span class="toc_mobile_items-number">1.1.1.4.</span> <span class="toc_mobile_items-text">1.4 RDB的缺点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-5-RDB的配置使用"><span class="toc_mobile_items-number">1.1.1.5.</span> <span class="toc_mobile_items-text">1.5 RDB的配置使用</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2、AOF"><span class="toc_mobile_items-number">1.1.2.</span> <span class="toc_mobile_items-text">2、AOF</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-1-AOF介绍"><span class="toc_mobile_items-number">1.1.2.1.</span> <span class="toc_mobile_items-text">2.1 AOF介绍</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-3-AOF的优点"><span class="toc_mobile_items-number">1.1.2.2.</span> <span class="toc_mobile_items-text">2.3 AOF的优点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-4-AOF的缺点"><span class="toc_mobile_items-number">1.1.2.3.</span> <span class="toc_mobile_items-text">2.4 AOF的缺点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-5-AOF的配置使用"><span class="toc_mobile_items-number">1.1.2.4.</span> <span class="toc_mobile_items-text">2.5 AOF的配置使用</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#二、Redis集群-Master-Slave"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">二、Redis集群-Master&#x2F;Slave</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1、为什么需要主从复制"><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">1、为什么需要主从复制</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-容灾备份"><span class="toc_mobile_items-number">1.2.1.1.</span> <span class="toc_mobile_items-text">1.1 容灾备份</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-2-读写分离"><span class="toc_mobile_items-number">1.2.1.2.</span> <span class="toc_mobile_items-text">1.2 读写分离</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2、如何做主从复制"><span class="toc_mobile_items-number">1.2.2.</span> <span class="toc_mobile_items-text">2、如何做主从复制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3、主从复制配置"><span class="toc_mobile_items-number">1.2.3.</span> <span class="toc_mobile_items-text">3、主从复制配置</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-1-安装redis"><span class="toc_mobile_items-number">1.2.3.1.</span> <span class="toc_mobile_items-text">3.1 安装redis</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-2-配置主从关系"><span class="toc_mobile_items-number">1.2.3.2.</span> <span class="toc_mobile_items-text">3.2 配置主从关系</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-3-测试"><span class="toc_mobile_items-number">1.2.3.3.</span> <span class="toc_mobile_items-text">3.3 测试</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#三、Redis集群-Sentinel"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">三、Redis集群-Sentinel</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1、哨兵机制"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">1、哨兵机制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2、哨兵机制配置"><span class="toc_mobile_items-number">1.3.2.</span> <span class="toc_mobile_items-text">2、哨兵机制配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3、哨兵模式JavaAPI"><span class="toc_mobile_items-number">1.3.3.</span> <span class="toc_mobile_items-text">3、哨兵模式JavaAPI</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4、总结"><span class="toc_mobile_items-number">1.3.4.</span> <span class="toc_mobile_items-text">4、总结</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#四、Redis集群-Cluster"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">四、Redis集群-Cluster</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1、Redis-集群的特点"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">1、Redis 集群的特点:</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2、Redis集群搭建"><span class="toc_mobile_items-number">1.4.2.</span> <span class="toc_mobile_items-text">2、Redis集群搭建</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-1-准备工作"><span class="toc_mobile_items-number">1.4.2.1.</span> <span class="toc_mobile_items-text">2.1 准备工作</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-2-创建文件夹"><span class="toc_mobile_items-number">1.4.2.2.</span> <span class="toc_mobile_items-text">2.2 创建文件夹</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-3-修改配置"><span class="toc_mobile_items-number">1.4.2.3.</span> <span class="toc_mobile_items-text">2.3 修改配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-4-启动redis进程"><span class="toc_mobile_items-number">1.4.2.4.</span> <span class="toc_mobile_items-text">2.4 启动redis进程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-5-安装ruby运行环境"><span class="toc_mobile_items-number">1.4.2.5.</span> <span class="toc_mobile_items-text">2.5 安装ruby运行环境</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-6-创建redis集群"><span class="toc_mobile_items-number">1.4.2.6.</span> <span class="toc_mobile_items-text">2.6 创建redis集群</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-7-测试集群"><span class="toc_mobile_items-number">1.4.2.7.</span> <span class="toc_mobile_items-text">2.7 测试集群</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3、-集群管理"><span class="toc_mobile_items-number">1.4.3.</span> <span class="toc_mobile_items-text">3、 集群管理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-3-JavaAPI操作redis集群"><span class="toc_mobile_items-number">1.4.4.</span> <span class="toc_mobile_items-text">1.3. JavaAPI操作redis集群</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#五、扩展知识"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">五、扩展知识</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1、桌面管理工具"><span class="toc_mobile_items-number">1.5.1.</span> <span class="toc_mobile_items-text">1、桌面管理工具</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-安装桌面管理工具"><span class="toc_mobile_items-number">1.5.1.1.</span> <span class="toc_mobile_items-text">1.1 安装桌面管理工具</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-2-启动redis服务"><span class="toc_mobile_items-number">1.5.1.2.</span> <span class="toc_mobile_items-text">1.2 启动redis服务</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-3-连接Redis库"><span class="toc_mobile_items-number">1.5.1.3.</span> <span class="toc_mobile_items-text">1.3 连接Redis库</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-4-使用"><span class="toc_mobile_items-number">1.5.1.4.</span> <span class="toc_mobile_items-text">1.4 使用</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2、密码授权"><span class="toc_mobile_items-number">1.5.2.</span> <span class="toc_mobile_items-text">2、密码授权</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-1-通过配置文件设置密码"><span class="toc_mobile_items-number">1.5.2.1.</span> <span class="toc_mobile_items-text">2.1 通过配置文件设置密码</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-2-通过命令设置密码"><span class="toc_mobile_items-number">1.5.2.2.</span> <span class="toc_mobile_items-text">2.2 通过命令设置密码</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-3-使用JavaAPI连接"><span class="toc_mobile_items-number">1.5.2.3.</span> <span class="toc_mobile_items-text">2.3  使用JavaAPI连接</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3、Redis发布订阅"><span class="toc_mobile_items-number">1.5.3.</span> <span class="toc_mobile_items-text">3、Redis发布订阅</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-1-常用指令"><span class="toc_mobile_items-number">1.5.3.1.</span> <span class="toc_mobile_items-text">3.1 常用指令</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-2-实例"><span class="toc_mobile_items-number">1.5.3.2.</span> <span class="toc_mobile_items-text">3.2 实例</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4、Redis事务"><span class="toc_mobile_items-number">1.5.4.</span> <span class="toc_mobile_items-text">4、Redis事务</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#4-1-Reids事务介绍"><span class="toc_mobile_items-number">1.5.4.1.</span> <span class="toc_mobile_items-text">4.1 Reids事务介绍</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#4-2-使用"><span class="toc_mobile_items-number">1.5.4.2.</span> <span class="toc_mobile_items-text">4.2 使用</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#5、缓存雪崩-穿透-降级"><span class="toc_mobile_items-number">1.5.5.</span> <span class="toc_mobile_items-text">5、缓存雪崩&#x2F;穿透&#x2F;降级</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#5-1-缓存雪崩"><span class="toc_mobile_items-number">1.5.5.1.</span> <span class="toc_mobile_items-text">5.1 缓存雪崩</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#5-2-缓存穿透"><span class="toc_mobile_items-number">1.5.5.2.</span> <span class="toc_mobile_items-text">5.2 缓存穿透</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#5-3-缓存预热"><span class="toc_mobile_items-number">1.5.5.3.</span> <span class="toc_mobile_items-text">5.3 缓存预热</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#5-4-缓存降级"><span class="toc_mobile_items-number">1.5.5.4.</span> <span class="toc_mobile_items-text">5.4 缓存降级</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#6、Redis线程安全问题"><span class="toc_mobile_items-number">1.5.6.</span> <span class="toc_mobile_items-text">6、Redis线程安全问题</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#7、Redis在项目中的应用"><span class="toc_mobile_items-number">1.5.7.</span> <span class="toc_mobile_items-text">7、Redis在项目中的应用</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis学习笔记（二）"><span class="toc-number">1.</span> <span class="toc-text">Redis学习笔记（二）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、Redis持久化"><span class="toc-number">1.1.</span> <span class="toc-text">一、Redis持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、RDB"><span class="toc-number">1.1.1.</span> <span class="toc-text">1、RDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-RDB介绍"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">1.1 RDB介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-RDB的工作方式"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">1.2 RDB的工作方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-RDB的优点"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">1.3 RDB的优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-RDB的缺点"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">1.4 RDB的缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-RDB的配置使用"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">1.5 RDB的配置使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、AOF"><span class="toc-number">1.1.2.</span> <span class="toc-text">2、AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-AOF介绍"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">2.1 AOF介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-AOF的优点"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">2.3 AOF的优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-AOF的缺点"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">2.4 AOF的缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-AOF的配置使用"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">2.5 AOF的配置使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Redis集群-Master-Slave"><span class="toc-number">1.2.</span> <span class="toc-text">二、Redis集群-Master&#x2F;Slave</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、为什么需要主从复制"><span class="toc-number">1.2.1.</span> <span class="toc-text">1、为什么需要主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-容灾备份"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1.1 容灾备份</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-读写分离"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">1.2 读写分离</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、如何做主从复制"><span class="toc-number">1.2.2.</span> <span class="toc-text">2、如何做主从复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、主从复制配置"><span class="toc-number">1.2.3.</span> <span class="toc-text">3、主从复制配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-安装redis"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">3.1 安装redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-配置主从关系"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">3.2 配置主从关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-测试"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">3.3 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、Redis集群-Sentinel"><span class="toc-number">1.3.</span> <span class="toc-text">三、Redis集群-Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、哨兵机制"><span class="toc-number">1.3.1.</span> <span class="toc-text">1、哨兵机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、哨兵机制配置"><span class="toc-number">1.3.2.</span> <span class="toc-text">2、哨兵机制配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、哨兵模式JavaAPI"><span class="toc-number">1.3.3.</span> <span class="toc-text">3、哨兵模式JavaAPI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、总结"><span class="toc-number">1.3.4.</span> <span class="toc-text">4、总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、Redis集群-Cluster"><span class="toc-number">1.4.</span> <span class="toc-text">四、Redis集群-Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、Redis-集群的特点"><span class="toc-number">1.4.1.</span> <span class="toc-text">1、Redis 集群的特点:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、Redis集群搭建"><span class="toc-number">1.4.2.</span> <span class="toc-text">2、Redis集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-准备工作"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">2.1 准备工作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-创建文件夹"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">2.2 创建文件夹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-修改配置"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">2.3 修改配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-启动redis进程"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">2.4 启动redis进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-安装ruby运行环境"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">2.5 安装ruby运行环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-创建redis集群"><span class="toc-number">1.4.2.6.</span> <span class="toc-text">2.6 创建redis集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-测试集群"><span class="toc-number">1.4.2.7.</span> <span class="toc-text">2.7 测试集群</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、-集群管理"><span class="toc-number">1.4.3.</span> <span class="toc-text">3、 集群管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-JavaAPI操作redis集群"><span class="toc-number">1.4.4.</span> <span class="toc-text">1.3. JavaAPI操作redis集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、扩展知识"><span class="toc-number">1.5.</span> <span class="toc-text">五、扩展知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、桌面管理工具"><span class="toc-number">1.5.1.</span> <span class="toc-text">1、桌面管理工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-安装桌面管理工具"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">1.1 安装桌面管理工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-启动redis服务"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">1.2 启动redis服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-连接Redis库"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">1.3 连接Redis库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-使用"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">1.4 使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、密码授权"><span class="toc-number">1.5.2.</span> <span class="toc-text">2、密码授权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-通过配置文件设置密码"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">2.1 通过配置文件设置密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-通过命令设置密码"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">2.2 通过命令设置密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-使用JavaAPI连接"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">2.3  使用JavaAPI连接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、Redis发布订阅"><span class="toc-number">1.5.3.</span> <span class="toc-text">3、Redis发布订阅</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-常用指令"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">3.1 常用指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-实例"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">3.2 实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、Redis事务"><span class="toc-number">1.5.4.</span> <span class="toc-text">4、Redis事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-Reids事务介绍"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">4.1 Reids事务介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-使用"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">4.2 使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、缓存雪崩-穿透-降级"><span class="toc-number">1.5.5.</span> <span class="toc-text">5、缓存雪崩&#x2F;穿透&#x2F;降级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-缓存雪崩"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">5.1 缓存雪崩</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-缓存穿透"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">5.2 缓存穿透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-缓存预热"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">5.3 缓存预热</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-缓存降级"><span class="toc-number">1.5.5.4.</span> <span class="toc-text">5.4 缓存降级</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、Redis线程安全问题"><span class="toc-number">1.5.6.</span> <span class="toc-text">6、Redis线程安全问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、Redis在项目中的应用"><span class="toc-number">1.5.7.</span> <span class="toc-text">7、Redis在项目中的应用</span></a></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">redis/Redis学习笔记（二）</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2020-08-04<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2020-08-02</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="Redis学习笔记（二）"><a href="#Redis学习笔记（二）" class="headerlink" title="Redis学习笔记（二）"></a>Redis学习笔记（二）</h1><h2 id="一、Redis持久化"><a href="#一、Redis持久化" class="headerlink" title="一、Redis持久化"></a>一、Redis持久化</h2><p>  由于Redis是一个内存数据库，所有的数据都是保存在内存当中的，内存当中的数据极易丢失，所以Redis的数据持久化就显得尤为重要，在Redis当中，提供了两种数据持久化的方式，分别为RDB-Redis DataBase和 AOF-Append Only File，且redis默认开启的数据持久化方式为RDB方式。</p>
<h3 id="1、RDB"><a href="#1、RDB" class="headerlink" title="1、RDB"></a>1、RDB</h3><h4 id="1-1-RDB介绍"><a href="#1-1-RDB介绍" class="headerlink" title="1.1 RDB介绍"></a>1.1 RDB介绍</h4><p>  Redis默认开启RDB快照,会根据配置定期保存数据快照至一个rbd文件中，并在启动时自动加载rdb文件，恢复之前保存的数据。</p>
<h4 id="1-2-RDB的工作方式"><a href="#1-2-RDB的工作方式" class="headerlink" title="1.2 RDB的工作方式"></a>1.2 RDB的工作方式</h4><p>当 Redis 需要保存 dump.rdb 文件时， 服务器执行以下操作:</p>
<ul>
<li>Redis 调用forks. 同时拥有父进程和子进程。</li>
<li>子进程将数据集写入到一个临时 RDB 文件中。</li>
<li>当子进程完成对新 RDB 文件的写入时，Redis 用新 RDB 文件替换原来的 RDB 文件，并删除旧的 RDB 文件。</li>
</ul>
<p><a href="https://s1.ax1x.com/2020/07/09/Ue2B8A.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="Ue2B8A.png" class="fancybox"><img alt="Ue2B8A.png" title="Ue2B8A.png" data-src="https://s1.ax1x.com/2020/07/09/Ue2B8A.png" class="lazyload"></a></p>
<h4 id="1-3-RDB的优点"><a href="#1-3-RDB的优点" class="headerlink" title="1.3 RDB的优点"></a>1.3 RDB的优点</h4><ul>
<li>对性能影响较小, 因为是开启一个子进程进行的快照操作</li>
<li>方便恢复,每次生成的快照都是当前时刻全部数据</li>
<li>数据速度较快,是二进制的内存dump文件</li>
</ul>
<h4 id="1-4-RDB的缺点"><a href="#1-4-RDB的缺点" class="headerlink" title="1.4 RDB的缺点"></a>1.4 RDB的缺点</h4><ul>
<li>Redis要完整的保存整个数据集是一个比较繁重的工作，通常是定期执行备份，但如果发生意外，可能会丢失一部分数据。</li>
<li>在数据集巨大并且CPU性能不是很好的情况下,fork子进程时可能会消耗相对较长的时间，影响Redis服务。</li>
</ul>
<h4 id="1-5-RDB的配置使用"><a href="#1-5-RDB的配置使用" class="headerlink" title="1.5 RDB的配置使用"></a>1.5 RDB的配置使用</h4><ul>
<li><p>修改配置文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis的配置文件目录</span></span><br><span class="line">cd /export/servers/redis/conf/</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">编辑配置文件</span></span><br><span class="line">vim redis_6379.conf </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置格式</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 	sava [seconds] [number]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">例如：</span></span><br><span class="line">sava 60 10</span><br><span class="line"><span class="meta">#</span><span class="bash">解释</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	seconds：秒为单位</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	number：key发生变化的次数</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>配置文件:</p>
<p><a href="https://s1.ax1x.com/2020/07/09/UeTtbR.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="UeTtbR.png" class="fancybox"><img alt="UeTtbR.png" title="UeTtbR.png" data-src="https://s1.ax1x.com/2020/07/09/UeTtbR.png" class="lazyload"></a></p>
</li>
</ul>
<h3 id="2、AOF"><a href="#2、AOF" class="headerlink" title="2、AOF"></a>2、AOF</h3><h4 id="2-1-AOF介绍"><a href="#2-1-AOF介绍" class="headerlink" title="2.1 AOF介绍"></a>2.1 AOF介绍</h4><p>  快照功能并不是非常耐久： 如果 Redis 因为某些原因而造成故障停机， 那么服务器将丢失最近写入、且仍未保存到快照中的那些数据。 从 1.1 版本开始， Redis 增加了一种完全耐久的持久化方式： AOF 持久化。</p>
<p><a href="https://s1.ax1x.com/2020/07/09/UmQ1Y9.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="UmQ1Y9.png" class="fancybox"><img alt="UmQ1Y9.png" title="UmQ1Y9.png" data-src="https://s1.ax1x.com/2020/07/09/UmQ1Y9.png" class="lazyload"></a></p>
<h4 id="2-3-AOF的优点"><a href="#2-3-AOF的优点" class="headerlink" title="2.3 AOF的优点"></a>2.3 AOF的优点</h4><ul>
<li>最安全, 可以最小程度上避免数据丢失, always会记录每一条操作日志,数据绝对安全, everysec最多也就丢失1s的数据</li>
<li>断电时日志损坏也不影响其他数据的恢复,redis中有redis-check-aof工具可以修复/忽略损坏的那一条日志,最多丢失这一条数据</li>
<li>AOF文件易读的可以人为修改</li>
<li>AOF有rewrite机制,可以合并无效的日志</li>
</ul>
<h4 id="2-4-AOF的缺点"><a href="#2-4-AOF的缺点" class="headerlink" title="2.4 AOF的缺点"></a>2.4 AOF的缺点</h4><ul>
<li><p>AOF文件不是二进制的,会比较大</p>
</li>
<li><p>如果配置的always每次操作都是记录日志,会影响性能</p>
</li>
<li><p>数据恢复需要加载AOF文件,所以速度会比RDB慢</p>
</li>
<li><p>相同的数据集来说，AOF 文件的体积通常要大于 RDB 文件（二进制文件）的体积。</p>
</li>
</ul>
<h4 id="2-5-AOF的配置使用"><a href="#2-5-AOF的配置使用" class="headerlink" title="2.5 AOF的配置使用"></a>2.5 AOF的配置使用</h4><ul>
<li><p>修改配置文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis的配置文件中</span></span><br><span class="line">cd /export/servers/redis/conf/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">编辑配置文件</span></span><br><span class="line">vim redis_6379.conf</span><br></pre></td></tr></tbody></table></figure></div>

<p>配置信息如下：</p>
<p><a href="https://s1.ax1x.com/2020/07/09/UmlHCd.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="UmlHCd.png" class="fancybox"><img alt="UmlHCd.png" title="UmlHCd.png" data-src="https://s1.ax1x.com/2020/07/09/UmlHCd.png" class="lazyload"></a></p>
<p>解释配置信息：</p>
<p>appendfsync: 同步时机</p>
<ul>
<li>no: 不进行fsync，将flush文件的时机交给OS操作系统决定</li>
<li>alway：每写入一条日志就进行一次fsync操作，数据安全性最高,但每个操作都会触发一次fsync，会对Redis的性能有比较明显的影响</li>
<li>everysec：折中的做法，交由后台线程每秒fsync一次，这个最常用的，生产环境一般都这么配置，性能很高，QPS还是可以上万的</li>
</ul>
<p>appendonly：是否开启AOF</p>
<ul>
<li>yes：开启AOF</li>
</ul>
<p>addpendfilename：aof的日志文件名</p>
<ul>
<li>appendonly.aof :只是默认的文件名</li>
</ul>
</li>
</ul>
<h2 id="二、Redis集群-Master-Slave"><a href="#二、Redis集群-Master-Slave" class="headerlink" title="二、Redis集群-Master/Slave"></a>二、Redis集群-Master/Slave</h2><h3 id="1、为什么需要主从复制"><a href="#1、为什么需要主从复制" class="headerlink" title="1、为什么需要主从复制"></a>1、为什么需要主从复制</h3><h4 id="1-1-容灾备份"><a href="#1-1-容灾备份" class="headerlink" title="1.1 容灾备份"></a>1.1 容灾备份</h4><p>  通过持久化功能，Redis保证了即使在服务器重启的情况下也不会丢失（或少量丢失）数据，但是由于数据是存储在一台服务器上的，如果这台服务器出现故障，比如硬盘坏了，也会导致数据丢失。为了避免单点故障，我们需要将数据复制多份部署在多台不同的服务器上，即使有一台服务器出现故障其他服务器依然可以继续提供服务。这就要求当一台服务器上的数据更新后，自动将更新的数据同步到其他服务器上，这时候就用到了Redis的主从复制。</p>
<h4 id="1-2-读写分离"><a href="#1-2-读写分离" class="headerlink" title="1.2 读写分离"></a>1.2 读写分离</h4><p>   另一方面Redis虽然读取写入的速度都特别快，但是也会产生读压力特别大的情况。为了分担读压力，Redis支持主从复制，Redis的主从结构可以采用一主多从或者级联结构，Redis主从复制可以根据是否是全量分为全量同步和增量同步。 </p>
<h3 id="2、如何做主从复制"><a href="#2、如何做主从复制" class="headerlink" title="2、如何做主从复制"></a>2、如何做主从复制</h3><p>  我们可以通过部署多台redis，并在配置文件中指定这几台redis之间的主从关系，主负责写入数据，同时把写入的数据实时同步到从机器，这种模式叫做主从复制，即master/slave，并且master用于写，slave用于读，向slave写数据会导致错误。</p>
<p><a href="https://s1.ax1x.com/2020/07/09/Umc3hd.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="Umc3hd.png" class="fancybox"><img alt="Umc3hd.png" title="Umc3hd.png" data-src="https://s1.ax1x.com/2020/07/09/Umc3hd.png" class="lazyload"></a></p>
<h3 id="3、主从复制配置"><a href="#3、主从复制配置" class="headerlink" title="3、主从复制配置"></a>3、主从复制配置</h3><h4 id="3-1-安装redis"><a href="#3-1-安装redis" class="headerlink" title="3.1 安装redis"></a>3.1 安装redis</h4><p>​        <a href>详见Redis学习笔记（一）</a></p>
<h4 id="3-2-配置主从关系"><a href="#3-2-配置主从关系" class="headerlink" title="3.2 配置主从关系"></a>3.2 配置主从关系</h4><p>  当所有机器的Redis安装之后，再配置主从关系。主机器不需要任何配置，在从机器上配置主从关系</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">所有从机器配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">进入配置文件所在目录</span></span><br><span class="line">cd /export/servers/redis/conf/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">编辑配置文件</span></span><br><span class="line">vim redis_6379.conf </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">进入文件后</span></span><br><span class="line"><span class="meta">#</span><span class="bash">添加一行 slaveof 参数</span></span><br><span class="line">slaveof node01 6379</span><br><span class="line"><span class="meta">#</span><span class="bash">解释</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	slaveof host port</span></span><br><span class="line"><span class="meta">#</span><span class="bash">		host:主机器地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash">		port:主机器的Redis端口</span></span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="3-3-测试"><a href="#3-3-测试" class="headerlink" title="3.3 测试"></a>3.3 测试</h4><p>  开启主从机器的Redis服务，再打开Redis客户端。</p>
<p>  主机器Redis客户端测试</p>
<p><a href="https://s1.ax1x.com/2020/07/09/Umhy34.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="Umhy34.png" class="fancybox"><img alt="Umhy34.png" title="Umhy34.png" data-src="https://s1.ax1x.com/2020/07/09/Umhy34.png" class="lazyload"></a></p>
<p>  从机器Redis客户端测试</p>
<p><a href="https://imgchr.com/i/Umhx58" target="_blank" rel="noopener"><img alt="Umhx58.png" data-src="https://s1.ax1x.com/2020/07/09/Umhx58.png" class="lazyload"></a></p>
<h2 id="三、Redis集群-Sentinel"><a href="#三、Redis集群-Sentinel" class="headerlink" title="三、Redis集群-Sentinel"></a>三、Redis集群-Sentinel</h2><h3 id="1、哨兵机制"><a href="#1、哨兵机制" class="headerlink" title="1、哨兵机制"></a>1、哨兵机制</h3><p>  Sentinel（哨兵）是Redis 的高可用性解决方案：</p>
<p>  由一个或多个Sentinel 实例组成的Sentinel 系统可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，</p>
<p>  并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器。</p>
<p><a href="https://s1.ax1x.com/2020/07/09/Um4Z5T.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="Um4Z5T.png" class="fancybox"><img alt="Um4Z5T.png" title="Um4Z5T.png" data-src="https://s1.ax1x.com/2020/07/09/Um4Z5T.png" class="lazyload"></a></p>
<h3 id="2、哨兵机制配置"><a href="#2、哨兵机制配置" class="headerlink" title="2、哨兵机制配置"></a>2、哨兵机制配置</h3><ul>
<li><p>创建主从机器的配置文件（所有机器都要配）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis的配置文件目录</span></span><br><span class="line">cd /export/servers/redis/conf</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建并配置sentinel.conf文件</span></span><br><span class="line">vim sentinel.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">进入文件后</span></span><br><span class="line"><span class="meta">#</span><span class="bash">添加一下属性</span></span><br><span class="line"><span class="meta">#</span><span class="bash">修改<span class="built_in">bind</span>配置，每台机器修改为自己对应的主机名</span></span><br><span class="line">bind node-03  </span><br><span class="line"><span class="meta">#</span><span class="bash">配置sentinel服务后台运行</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta">#</span><span class="bash">修改三台机器监控的主节点，现在主节点是node01服务器</span></span><br><span class="line">sentinel monitor mymaster node01 6379 2</span><br><span class="line"><span class="meta">#</span><span class="bash">sentinel monitor代表监控，mymaster代表服务器的名称，可以自定义，node01代表监控的主服务器，6379代表端口，2代表只有两个或两个以上的哨兵认为主服务器不可用的时候，才会进行failover操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel author-pass定义服务的密码，mymaster是服务名称，123456是Redis服务器密码</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel auth-pass <master-name> <password></password></master-name></span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>启动redis服务</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动redis服务</span></span><br><span class="line">/export/servers/redis/bin/redis-server /export/servers/redis/conf/redis_6379.conf</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>启动哨兵服务</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动哨兵服务</span></span><br><span class="line">/export/servers/redis/bin/redis-sentinel /export/servers/redis/conf/sentinel.conf</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>启动redis客服端</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动两个从角色的redis的客户端</span></span><br><span class="line">/export/servers/redis/bin/redis-cli -h node01</span><br><span class="line">/export/servers/redis/bin/redis-cli -h node02</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动主角色的客户端</span></span><br><span class="line">/export/servers/redis/bin/redis-cli -h node03</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>查看各个角色的信息</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在客户端输入</span></span><br><span class="line">info</span><br></pre></td></tr></tbody></table></figure></div>

<p>查看主角色信息：</p>
<p>node-03结点为主角色</p>
<p><a href="https://s1.ax1x.com/2020/07/09/UmLyod.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="UmLyod.png" class="fancybox"><img alt="UmLyod.png" title="UmLyod.png" data-src="https://s1.ax1x.com/2020/07/09/UmLyod.png" class="lazyload"></a></p>
<p>查看从角色信息：</p>
<p>node-02结点为从角色</p>
<p><a href="https://s1.ax1x.com/2020/07/09/UmLjyT.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="UmLjyT.png" class="fancybox"><img alt="UmLjyT.png" title="UmLjyT.png" data-src="https://s1.ax1x.com/2020/07/09/UmLjyT.png" class="lazyload"></a></p>
<p>node-01结点为从角色</p>
<p><a href="https://s1.ax1x.com/2020/07/09/Umj2WR.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="Umj2WR.png" class="fancybox"><img alt="Umj2WR.png" title="Umj2WR.png" data-src="https://s1.ax1x.com/2020/07/09/Umj2WR.png" class="lazyload"></a></p>
</li>
<li><p>测试</p>
<ul>
<li><p>杀死主角色</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">找到主角色的redis服务</span></span><br><span class="line">ps -ef | grep redis  </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">使用<span class="built_in">kill</span> -9 进程号，杀死主角色</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>等待一会</p>
</li>
<li><p>查看各从角色信息，其中一个从角色会上升为主角色</p>
<p><a href="https://s1.ax1x.com/2020/07/09/UmjQQP.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="UmjQQP.png" class="fancybox"><img alt="UmjQQP.png" title="UmjQQP.png" data-src="https://s1.ax1x.com/2020/07/09/UmjQQP.png" class="lazyload"></a></p>
</li>
<li><p>再次启动刚刚杀死的redis，发现该结点变成从节点了</p>
<p><a href="https://s1.ax1x.com/2020/07/09/UmxY2n.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="UmxY2n.png" class="fancybox"><img alt="UmxY2n.png" title="UmxY2n.png" data-src="https://s1.ax1x.com/2020/07/09/UmxY2n.png" class="lazyload"></a></p>
</li>
</ul>
</li>
</ul>
<h3 id="3、哨兵模式JavaAPI"><a href="#3、哨兵模式JavaAPI" class="headerlink" title="3、哨兵模式JavaAPI"></a>3、哨兵模式JavaAPI</h3><p>下面是连接主从+哨兵模式的redis集群</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SentinelTest</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMasterSlaveAndSentinel</span><span class="params">()</span></span>{</span><br><span class="line">       <span class="comment">//1.创建连接池配置对象</span></span><br><span class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        jedisPoolConfig.setMaxTotal(<span class="number">100</span>);<span class="comment">//设置最大连接</span></span><br><span class="line">        jedisPoolConfig.setMaxIdle(<span class="number">10</span>);<span class="comment">//设置最大空闲连接</span></span><br><span class="line">        jedisPoolConfig.setMinIdle(<span class="number">5</span>);<span class="comment">//设置最小空闲连接</span></span><br><span class="line">        jedisPoolConfig.setMaxWaitMillis(<span class="number">2000</span>);<span class="comment">//设置最长等待时间</span></span><br><span class="line">        jedisPoolConfig.setTestOnCreate(<span class="keyword">true</span>);</span><br><span class="line">        jedisPoolConfig.setTestOnBorrow(<span class="keyword">true</span>);</span><br><span class="line">        jedisPoolConfig.setTestOnReturn(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.创建连接对象</span></span><br><span class="line">        <span class="comment">//准备哨兵地址，注意哨兵的默认端口为26379</span></span><br><span class="line">        Set<string> sentinels = <span class="keyword">new</span> HashSet<>(Arrays.asList(<span class="string">"node-01:26379"</span>,<span class="string">"node-02:26379"</span>,<span class="string">"node-03:26379"</span>));</string></span><br><span class="line">        JedisSentinelPool jedisSentinelPool = <span class="keyword">new</span> JedisSentinelPool(<span class="string">"mymaster"</span>, sentinels,jedisPoolConfig);</span><br><span class="line">        <span class="comment">//3.从连接池中获取连接对象</span></span><br><span class="line">        Jedis jedis = jedisSentinelPool.getResource();</span><br><span class="line">        <span class="comment">//4.测试</span></span><br><span class="line">        String ping = jedis.ping();</span><br><span class="line">        System.out.println(ping);</span><br><span class="line">        <span class="comment">//5.归还连接</span></span><br><span class="line">        jedis.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="4、总结"><a href="#4、总结" class="headerlink" title="4、总结"></a>4、总结</h3><p>  开发中一般都是 主从+ 哨兵 就可以满足大部分场景。如果还需对redis做扩展，就需要使用Cluster集群，因为主从集群不能实现水平扩展</p>
<h2 id="四、Redis集群-Cluster"><a href="#四、Redis集群-Cluster" class="headerlink" title="四、Redis集群-Cluster"></a>四、Redis集群-Cluster</h2><p>1.1. Redis-Cluster介绍</p>
<p>  sentinel模式基本可以满足一般生产的需求，具备高可用性。但是当数据量过大到一台服务器存放不下的情况时，主从模式或sentinel模式就不能满足需求了，这个时候需要对存储的数据进行分片，将数据存储到多个Redis实例中。cluster模式的出现就是为了解决单机Redis容量有限的问题，将Redis的数据根据一定的规则分配到多台机器。</p>
<p>  cluster可以说是sentinel和主从模式的结合体，通过cluster可以实现主从和master重选功能，</p>
<p>  所以如果配置两个副本三个分片的话，就需要六个Redis实例。因为Redis的数据是根据一定规则分配到cluster的不同机器的，当数据量过大时，可以新增机器进行扩容。</p>
<p><a href="https://s1.ax1x.com/2020/07/09/UmcZ11.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption="UmcZ11.jpg" class="fancybox"><img alt="UmcZ11.jpg" title="UmcZ11.jpg" data-src="https://s1.ax1x.com/2020/07/09/UmcZ11.jpg" class="lazyload"></a></p>
<h3 id="1、Redis-集群的特点"><a href="#1、Redis-集群的特点" class="headerlink" title="1、Redis 集群的特点:"></a>1、Redis 集群的特点:</h3><ul>
<li><p>缓存永不宕机：启动集群，永远让集群的一部分起作用。主节点失效了子节点能迅速改变角色成为主节点，整个集群的部分节点失败或者不可达的情况下能够继续处理命令；</p>
</li>
<li><p>迅速恢复数据：持久化数据，能在宕机后迅速解决数据丢失的问题；</p>
</li>
<li><p>Redis可以使用所有机器的内存，变相扩展性能；</p>
</li>
<li><p>使Redis的计算能力通过简单地增加服务器得到成倍提升,Redis的网络带宽也会随着计算机和网卡的增加而成倍增长；</p>
</li>
<li><p>Redis集群没有中心节点，不会因为某个节点成为整个集群的性能瓶颈;</p>
</li>
<li><p>异步处理数据，实现快速读写。</p>
</li>
<li><p>Redis集群预分好16384个桶/槽，当需要在 Redis 集群中放置一个 key-value 时，根据 CRC16(key) mod 16384的值，决定将一个key放到哪个桶/槽中</p>
</li>
</ul>
<h3 id="2、Redis集群搭建"><a href="#2、Redis集群搭建" class="headerlink" title="2、Redis集群搭建"></a>2、Redis集群搭建</h3><p>  Redis集群当中最少需要三个主节点，每个主节点，最少需要一个对应的从节点，所以搭建redis集群最少需要三主三从的配置，所以redis集群最少需要6台redis的实例，我们这里使用node01服务器，通过配置不同的端口，实现redis集群的环境搭建</p>
<h4 id="2-1-准备工作"><a href="#2-1-准备工作" class="headerlink" title="2.1 准备工作"></a>2.1 准备工作</h4><p> 在node-02上准备一个新的redis解压到redis-cluster上</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis安装包所在目录</span></span><br><span class="line">cd /export/software/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建一个redis-cluster目录,用于模拟多机器</span></span><br><span class="line">mkdir -p /export/servers/redis-cluster</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">解压redis安装包</span></span><br><span class="line">tar -zxvf redis-4.0.2.tar.gz  -C ../servers/redis-cluster</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="2-2-创建文件夹"><a href="#2-2-创建文件夹" class="headerlink" title="2.2 创建文件夹"></a>2.2 创建文件夹</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis</span></span><br><span class="line">cd /export/servers/redis-cluster/redis</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建各个节点的配置文件</span></span><br><span class="line">mkdir -p /export/servers/redis-cluster/redis/clusters/7001</span><br><span class="line"></span><br><span class="line">mkdir -p /export/servers/redis-cluster/redis/clusters/7002</span><br><span class="line"></span><br><span class="line">mkdir -p /export/servers/redis-cluster/redis/clusters/7003</span><br><span class="line"></span><br><span class="line">mkdir -p /export/servers/redis-cluster/redis/clusters/7004</span><br><span class="line"></span><br><span class="line">mkdir -p /export/servers/redis-cluster/redis/clusters/7005</span><br><span class="line"></span><br><span class="line">mkdir -p /export/servers/redis-cluster/redis/clusters/7006</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">创建各个节点的数据存放地方</span></span><br><span class="line">mkdir -p /export/data/redis-cluster/redisdata_7001/</span><br><span class="line"></span><br><span class="line">mkdir -p /export/data/redis-cluster/redisdata_7002/</span><br><span class="line"></span><br><span class="line">mkdir -p /export/data/redis-cluster/redisdata_7003/</span><br><span class="line"></span><br><span class="line">mkdir -p /export/data/redis-cluster/redisdata_7004/</span><br><span class="line"></span><br><span class="line">mkdir -p /export/data/redis-cluster/redisdata_7005/</span><br><span class="line"></span><br><span class="line">mkdir -p /export/data/redis-cluster/redisdata_7006/</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="2-3-修改配置"><a href="#2-3-修改配置" class="headerlink" title="2.3 修改配置"></a>2.3 修改配置</h4><p> 修改redis的六个配置文件，注释的地方需要修改</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">编辑各个节点的配置文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件路径依次修改为</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/servers/redis-cluster/redis/clusters/7001/redis_7001.conf		</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/servers/redis-cluster/redis/clusters/7002/redis_7002.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/servers/redis-cluster/redis/clusters/7003/redis_7003.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/servers/redis-cluster/redis/clusters/7004/redis_7004.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/servers/redis-cluster/redis/clusters/7005/redis_7005.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/servers/redis-cluster/redis/clusters/7006/redis_7006.conf</span></span><br><span class="line">vim /export/servers/redis-cluster/redis/clusters/7001/redis_7001.conf</span><br><span class="line"></span><br><span class="line">bind node-02</span><br><span class="line">protected-mode yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口号一次修改为：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 			7001</span></span><br><span class="line"><span class="meta">#</span><span class="bash">			7002</span></span><br><span class="line"><span class="meta">#</span><span class="bash">			7003</span></span><br><span class="line"><span class="meta">#</span><span class="bash">			7004</span></span><br><span class="line"><span class="meta">#</span><span class="bash">			7005</span></span><br><span class="line"><span class="meta">#</span><span class="bash">			7006</span></span><br><span class="line">port 7001</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line"><span class="meta">#</span><span class="bash">修改pid存储的位置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">依次修改为：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redis_7001.pid</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redis_7002.pid</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redis_7003.pid</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redis_7004.pid	</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redis_7005.pid</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redis_7006.pid</span></span><br><span class="line">pidfile /export/data/redis-cluster/redis_7001.pid</span><br><span class="line">loglevel notice</span><br><span class="line"><span class="meta">#</span><span class="bash">修改日志文件放置的位置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">依次修改为：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	<span class="string">"/export/data/redis-cluster/log_7001.log"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">	<span class="string">"/export/data/redis-cluster/log_7002.log"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">	<span class="string">"/export/data/redis-cluster/log_7003.log"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">	<span class="string">"/export/data/redis-cluster/log_7004.log"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">	<span class="string">"/export/data/redis-cluster/log_7005.log"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">	<span class="string">"/export/data/redis-cluster/log_7006.log"</span></span></span><br><span class="line">logfile "/export/data/redis-cluster/log_7001.log"</span><br><span class="line">databases 16</span><br><span class="line">always-show-logo yes</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"><span class="meta">#</span><span class="bash">修改持久化数据文件放置的位置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">依次修改为：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redisdata_7001/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redisdata_7002/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redisdata_7003/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redisdata_7004/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redisdata_7005/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	/<span class="built_in">export</span>/data/redis-cluster/redisdata_7006/</span></span><br><span class="line">dir /export/data/redis-cluster/redisdata_7001/</span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">slave-priority 100</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">slave-lazy-flush no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename "appendonly.aof"</span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble no</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events ""</span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line"><span class="meta">#</span><span class="bash">添加内容:  开启集群模式, 集群的配置文件, 以及超时时间</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">依次修改为：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	redis_7001.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	redis_7002.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	redis_7003.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	redis_7004.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	redis_7005.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	redis_7006.conf</span></span><br><span class="line">cluster-config-file redis_7001.conf</span><br><span class="line">cluster-node-timeout 5000</span><br></pre></td></tr></tbody></table></figure></div>







<h4 id="2-4-启动redis进程"><a href="#2-4-启动redis进程" class="headerlink" title="2.4 启动redis进程"></a>2.4 启动redis进程</h4><p>node01上执行以下命令来启动redis集群</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis目录内</span></span><br><span class="line">cd /export/servers/redis-cluster/redis</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">一次启动redis集群</span></span><br><span class="line">bin/redis-server clusters/7001/redis_7001.conf</span><br><span class="line"></span><br><span class="line">bin/redis-server clusters/7002/redis_7002.conf</span><br><span class="line"></span><br><span class="line">bin/redis-server clusters/7003/redis_7003.conf</span><br><span class="line"></span><br><span class="line">bin/redis-server clusters/7004/redis_7004.conf</span><br><span class="line"></span><br><span class="line">bin/redis-server clusters/7005/redis_7005.conf</span><br><span class="line"></span><br><span class="line">bin/redis-server clusters/7006/redis_7006.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看redis的进程</span></span><br><span class="line">ps -ef |grep redis</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="2-5-安装ruby运行环境"><a href="#2-5-安装ruby运行环境" class="headerlink" title="2.5 安装ruby运行环境"></a>2.5 安装ruby运行环境</h4><p>node01执行以下命令，安装ruby运行环境，因为redis集群的启动需要借助ruby的环境</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装ruby运行环境</span></span><br><span class="line">yum install -y ruby rubygems</span><br><span class="line"></span><br><span class="line">gem install redis</span><br></pre></td></tr></tbody></table></figure></div>

<p>这个时候可能会报错，如下：</p>
<p><a href="https://s1.ax1x.com/2020/07/10/UuSmZV.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption="UuSmZV.jpg" class="fancybox"><img alt="UuSmZV.jpg" title="UuSmZV.jpg" data-src="https://s1.ax1x.com/2020/07/10/UuSmZV.jpg" class="lazyload"></a></p>
<p>因为需要访问外网升级ruby版本 ,如果执行的过程中报错,把那条重新多执行几次。如果还行，解决方案如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis目录内</span></span><br><span class="line">cd /export/servers/redis-cluster/redis</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">以下是一行内容</span></span><br><span class="line">gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">使用curl</span></span><br><span class="line">curl -sSL https://get.rvm.io | bash -s stable</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重新加载文件</span></span><br><span class="line">source /etc/profile.d/rvm.sh  </span><br><span class="line"></span><br><span class="line">rvm list known</span><br><span class="line"></span><br><span class="line">rvm install 2.4.1</span><br><span class="line"></span><br><span class="line">gem install redis</span><br></pre></td></tr></tbody></table></figure></div>

<p>成功结果如下：</p>
<p><a href="https://s1.ax1x.com/2020/07/10/UupKmt.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption="UupKmt.jpg" class="fancybox"><img alt="UupKmt.jpg" title="UupKmt.jpg" data-src="https://s1.ax1x.com/2020/07/10/UupKmt.jpg" class="lazyload"></a></p>
<h4 id="2-6-创建redis集群"><a href="#2-6-创建redis集群" class="headerlink" title="2.6 创建redis集群"></a>2.6 创建redis集群</h4><ul>
<li>先复制redis源码包下的rb脚本到cluster/bin目录下</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/redis-cluster/redis-4.0.2/src</span><br><span class="line"></span><br><span class="line">cp redis-trib.rb   ../../redis/bin/</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li>创建分片</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入到cluster目录</span></span><br><span class="line">cd /export/servers/redis-cluster/redis</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建副本</span></span><br><span class="line">bin/redis-trib.rb create --replicas 1 192.168.1.101:7001 192.168.1.101:7002 192.168.1.101:7003 192.168.1.101:7004 192.168.1.101:7005 192.168.1.101:7006</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li><p>注意</p>
<p>如果创建cluster集群出现以下错误：</p>
<p><a href="https://s1.ax1x.com/2020/07/10/Uupf76.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption="Uupf76.jpg" class="fancybox"><img alt="Uupf76.jpg" title="Uupf76.jpg" data-src="https://s1.ax1x.com/2020/07/10/Uupf76.jpg" class="lazyload"></a></p>
<p>那么需要清空所有redis节点的所有数据</p>
<p>登录每一台redis节点: 共计为6台</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">分别启动6台机器的客户端</span></span><br><span class="line">bin/redis-cli  -h node01 -c -p 7001</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">执行以下命令</span></span><br><span class="line">flushall</span><br><span class="line"></span><br><span class="line">cluster reset</span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<h4 id="2-7-测试集群"><a href="#2-7-测试集群" class="headerlink" title="2.7 测试集群"></a>2.7 测试集群</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">开启各个客户端</span></span><br><span class="line"><span class="meta">#</span><span class="bash">分布执行以下命名</span></span><br><span class="line">info</span><br><span class="line"><span class="meta">#</span><span class="bash">可以找到看出</span></span><br><span class="line"><span class="meta">#</span><span class="bash">node-02的7001~7003都是master</span></span><br><span class="line"><span class="meta">#</span><span class="bash">node-01的7004~ 7005 都是salve</span></span><br></pre></td></tr></tbody></table></figure></div>



<h3 id="3、-集群管理"><a href="#3、-集群管理" class="headerlink" title="3、 集群管理"></a>3、 集群管理</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">添加一个新节点作为主节点</span></span><br><span class="line"><span class="meta">#</span><span class="bash">启动新节点的redis服务，然后添加到集群当中去</span></span><br><span class="line"><span class="meta">#</span><span class="bash">启动服务</span></span><br><span class="line">./redis-server clusters/7007/redis.conf</span><br><span class="line">./redis-trib.rb add-node 192.168.1.101:7007 192.168.1.101:7001</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">添加一个新节点作为副本</span></span><br><span class="line"></span><br><span class="line">./redis-server clusters/7008/redis.conf</span><br><span class="line">./redis-trib.rb add-node --slave 192.168.1.101:7008 192.168.1.101:7001</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">删除一个节点</span></span><br><span class="line"><span class="meta">#</span><span class="bash">命令格式</span></span><br><span class="line">./redis-trib del-node 127.0.0.1:7000 `<node-id>`</node-id></span><br><span class="line">./redis-trib.rb del-node 192.168.1.101:7008 7c7b7f68bc56bf24cbb36b599d2e2d97b26c5540</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重新分片</span></span><br><span class="line">./redis-trib.rb reshard 192.168.1.101:7001</span><br><span class="line">./redis-trib.rb reshard --from <node-id> --to <node-id> --slots <number of slots> --yes <host>:<port></port></host></number></node-id></node-id></span><br></pre></td></tr></tbody></table></figure></div>



<h3 id="1-3-JavaAPI操作redis集群"><a href="#1-3-JavaAPI操作redis集群" class="headerlink" title="1.3. JavaAPI操作redis集群"></a>1.3. JavaAPI操作redis集群</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRedisCluster</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">     <span class="comment">//1.创建连接池配置对象</span></span><br><span class="line">     JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">     jedisPoolConfig.setMaxTotal(<span class="number">100</span>);<span class="comment">//设置最大连接</span></span><br><span class="line">     jedisPoolConfig.setMaxIdle(<span class="number">10</span>);<span class="comment">//设置最大空闲连接数</span></span><br><span class="line">     jedisPoolConfig.setMinIdle(<span class="number">5</span>);<span class="comment">//设置最小空闲连接数</span></span><br><span class="line">     jedisPoolConfig.setMaxWaitMillis(<span class="number">2000</span>);<span class="comment">//最大等待时间</span></span><br><span class="line">     jedisPoolConfig.setTestOnCreate(<span class="keyword">true</span>);</span><br><span class="line">     jedisPoolConfig.setTestOnBorrow(<span class="keyword">true</span>);</span><br><span class="line">     jedisPoolConfig.setTestOnReturn(<span class="keyword">true</span>);</span><br><span class="line">     <span class="comment">//2.创建RedisCluster对象</span></span><br><span class="line">     <span class="comment">//准备RedisCluster节点集合</span></span><br><span class="line">     Set<hostandport> nodes = <span class="keyword">new</span> HashSet<>();</hostandport></span><br><span class="line">     nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"node01"</span>, <span class="number">7001</span>));</span><br><span class="line">     nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"node01"</span>, <span class="number">7002</span>));</span><br><span class="line">     nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"node01"</span>, <span class="number">7003</span>));</span><br><span class="line">     nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"node01"</span>, <span class="number">7004</span>));</span><br><span class="line">     nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"node01"</span>, <span class="number">7005</span>));</span><br><span class="line">     nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"node01"</span>, <span class="number">7006</span>));</span><br><span class="line">     JedisCluster jedisCluster = <span class="keyword">new</span> JedisCluster(nodes, jedisPoolConfig);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//3.直接使用Cluser对象进行操作</span></span><br><span class="line">     jedisCluster.set(<span class="string">"ck"</span>, <span class="string">"cv"</span>);</span><br><span class="line">     String value = jedisCluster.get(<span class="string">"ck"</span>);</span><br><span class="line">     System.out.println(value);</span><br><span class="line">     jedisCluster.close();</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="五、扩展知识"><a href="#五、扩展知识" class="headerlink" title="五、扩展知识"></a>五、扩展知识</h2><h3 id="1、桌面管理工具"><a href="#1、桌面管理工具" class="headerlink" title="1、桌面管理工具"></a>1、桌面管理工具</h3><h4 id="1-1-安装桌面管理工具"><a href="#1-1-安装桌面管理工具" class="headerlink" title="1.1 安装桌面管理工具"></a>1.1 安装桌面管理工具</h4><p>  下载<a href="https://www.oschina.net/news/110710/redis-desktop-manager-2019-4-released" target="_blank" rel="noopener">reids-desktop-manager</a>，直接解压运行</p>
<h4 id="1-2-启动redis服务"><a href="#1-2-启动redis服务" class="headerlink" title="1.2 启动redis服务"></a>1.2 启动redis服务</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis的bin目录内</span></span><br><span class="line">cd /export/servers/redis/bin/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动redis服务器</span></span><br><span class="line">./redis-server ../conf/redis_6379.conf</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="1-3-连接Redis库"><a href="#1-3-连接Redis库" class="headerlink" title="1.3 连接Redis库"></a>1.3 连接Redis库</h4><p><a href="https://i.loli.net/2020/07/18/bY6U1pdz3wtmyvx.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="QQ图片20200718215630.png" class="fancybox"><img alt="QQ图片20200718215630.png" title="QQ图片20200718215630.png" data-src="https://i.loli.net/2020/07/18/bY6U1pdz3wtmyvx.png" class="lazyload"></a></p>
<h4 id="1-4-使用"><a href="#1-4-使用" class="headerlink" title="1.4 使用"></a>1.4 使用</h4><p><a href="https://i.loli.net/2020/07/18/A3OtbXWImz1DdwC.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="QQ图片20200718215940.png" class="fancybox"><img alt="QQ图片20200718215940.png" title="QQ图片20200718215940.png" data-src="https://i.loli.net/2020/07/18/A3OtbXWImz1DdwC.png" class="lazyload"></a></p>
<h3 id="2、密码授权"><a href="#2、密码授权" class="headerlink" title="2、密码授权"></a>2、密码授权</h3><p>  Redis服务器一般用作内部缓存,不提供外部直接访问,所以默认是没有密码的，如果公司对于数据安全性要求较高,那么可以设置密码。配置有如下三种方式</p>
<h4 id="2-1-通过配置文件设置密码"><a href="#2-1-通过配置文件设置密码" class="headerlink" title="2.1 通过配置文件设置密码"></a>2.1 通过配置文件设置密码</h4><p>  该方式是持久性的，在redis的conf目录下的配置文件中修改</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis的配置文件目录中</span></span><br><span class="line">cd /export/servers/redis/conf</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">打开主配置文件</span></span><br><span class="line">vim redis_6379.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">进入配置文件后</span></span><br><span class="line"><span class="meta">#</span><span class="bash">添加或修改requirepass属性</span></span><br><span class="line"><span class="meta">#</span><span class="bash">格式：requirepass 密码</span></span><br><span class="line">requirepass ca4llc</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="2-2-通过命令设置密码"><a href="#2-2-通过命令设置密码" class="headerlink" title="2.2 通过命令设置密码"></a>2.2 通过命令设置密码</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入redis目录内</span></span><br><span class="line">cd /export/servers/redis/bin/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动redis服务器</span></span><br><span class="line">./redis-server ../conf/redis_6379.conf\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">打开redis客户端</span></span><br><span class="line">./redis-cli -h node-03</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">设置密码</span></span><br><span class="line">node03:6379> config set requirepass itcast</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">操作其他命令会提示需要授权</span></span><br><span class="line">node03:6379> keys *</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">输入密码完成授权</span></span><br><span class="line">node03:6379> auth ca4llc</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">这时就可以正常操作了</span></span><br><span class="line">node01:6379> keys *</span><br><span class="line">"k1"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">然后输入一下命令就可以关闭密码</span></span><br><span class="line"><span class="meta">#</span><span class="bash">需要先完成授权，才能执行这条命令</span></span><br><span class="line">node-03:6379> config set requirepass  ''</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>注意</strong></p>
<ul>
<li>只要服务器没有关闭，每次启动客户端后都需要验证密码</li>
</ul>
<h4 id="2-3-使用JavaAPI连接"><a href="#2-3-使用JavaAPI连接" class="headerlink" title="2.3  使用JavaAPI连接"></a>2.3  使用JavaAPI连接</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJedisAuth</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">//1.创建jedis连接对象</span></span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">"node-03"</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">"itcast"</span>);</span><br><span class="line">        <span class="comment">//2.测试是否可以连接redis服务器</span></span><br><span class="line">        String pong = jedis.ping();</span><br><span class="line">        System.out.println(pong);</span><br><span class="line">        <span class="comment">//3.关闭连接</span></span><br><span class="line">        jedis.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="3、Redis发布订阅"><a href="#3、Redis发布订阅" class="headerlink" title="3、Redis发布订阅"></a>3、Redis发布订阅</h3><p>  Redis 发布订阅(pub/sub)是一种消息通信模式：发送者(pub)发送消息，订阅者(sub)接收消息。Redis 客户端可以订阅任意数量的频道。下图展示了频道 channel1 ， 以及订阅这个频道的三个客户端 —— client2 、 client5 和 client1 之间的关系（类似微信公众号，用户订阅之后，只要公众号有新文章，用户就可以收到）：</p>
<p><a href="https://i.loli.net/2020/07/18/pMWyazn4C3LFtDq.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="1594198102738.png" class="fancybox"><img alt="1594198102738.png" title="1594198102738.png" data-src="https://i.loli.net/2020/07/18/pMWyazn4C3LFtDq.png" class="lazyload"></a></p>
<h4 id="3-1-常用指令"><a href="#3-1-常用指令" class="headerlink" title="3.1 常用指令"></a>3.1 常用指令</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">PSUBSCRIBE pattern [pattern ...]   订阅一个或多符合要求的频道</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">PUBSUB <subcommand> [argument [argument ...]]   查看订阅与发布系统状态</subcommand></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">PUBLISH channel message   将信息发送到指定的频道</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">PUNSUBSCRIBE [pattern [pattern ...]]   退订所有给定模式的频道</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">UNSUBSCRIBE channel [channel ...]  退订给定的一个或多个频道的信息</span></span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="3-2-实例"><a href="#3-2-实例" class="headerlink" title="3.2 实例"></a>3.2 实例</h4><p>  以下实例演示了发布订阅是如何工作的。在我们实例中我们创建了订阅频道名为 <strong>redisChat</strong>:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">订阅一个频道redisChat</span></span><br><span class="line">redis node-03:6379> SUBSCRIBE redisChat</span><br><span class="line"><span class="meta">#</span><span class="bash">出现的信息</span></span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) "subscribe"</span><br><span class="line">2) "redisChat"</span><br><span class="line">3) (integer) 1</span><br></pre></td></tr></tbody></table></figure></div>

<p>  现在，我们先重新开启个 redis 客户端，然后在同一个频道 redisChat 发布两次消息，订阅者就能接收到消息。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">发布消息</span></span><br><span class="line">redis node-03:6379> PUBLISH redisChat "Redis is a great caching technique"</span><br><span class="line"><span class="meta">#</span><span class="bash">出现的信息</span></span><br><span class="line">(integer) 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">发布消息</span></span><br><span class="line">redis node-03:6379> PUBLISH redisChat "Learn redis by runoob.com"</span><br><span class="line"><span class="meta">#</span><span class="bash">出现的信息</span></span><br><span class="line">(integer) 1</span><br></pre></td></tr></tbody></table></figure></div>

<p>  看看刚开始打开的客户端：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">会出现以下信息</span></span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) "subscribe"</span><br><span class="line">2) "redisChat"</span><br><span class="line">3) (integer) 1</span><br><span class="line">1) "message"</span><br><span class="line">2) "redisChat"</span><br><span class="line">3) "Redis is a great caching technique"</span><br><span class="line">1) "message"</span><br><span class="line">2) "redisChat"</span><br><span class="line">3) "Learn redis by itcast.com"</span><br></pre></td></tr></tbody></table></figure></div>



<h3 id="4、Redis事务"><a href="#4、Redis事务" class="headerlink" title="4、Redis事务"></a>4、Redis事务</h3><h4 id="4-1-Reids事务介绍"><a href="#4-1-Reids事务介绍" class="headerlink" title="4.1 Reids事务介绍"></a>4.1 Reids事务介绍</h4><p>  和众多其它数据库一样，Redis作为NoSQL数据库也同样提供了事务机制。Redis中事务的实现特征：</p>
<ul>
<li><p>在事务中的所有命令都将会被串行化的顺序执行，事务执行期间，Redis不会再为其它客户端的请求提供任何服务。</p>
</li>
<li><p>我们可以通过MULTI命令开启一个事务，可以将其理解为”BEGIN TRANSACTION”语句。在该语句之后执行的命令都将被视为事务之内的操作，最后我们可以通过执行EXEC/DISCARD命令来提交/回滚该事务内的所有操作。这两个Redis命令可被视为等同于关系型数据库中的COMMIT/ROLLBACK语句。</p>
</li>
<li><p>在事务开启之前，如果客户端与服务器之间出现通讯故障并导致网络断开，其后所有待执行的语句都将不会被服务器执行。然而如果网络中断事件是发生在客户端执行EXEC命令之后，那么该事务中的所有命令都会被服务器执行。</p>
</li>
</ul>
<p>  注意:</p>
<p>   单个 Redis 命令的执行是原子性的，但 Redis 没有在事务上增加任何维持原子性的机制，所以 Redis 事务的执行并不是原子性的。</p>
<p> Redis事务可以理解为一个打包的批量执行脚本，但批量指令并非原子化的操作，中间某条指令的失败不会导致前面已做指令的回滚，也不会造成后续的指令不做。所以Redis支持事务，但是不够严格完整。</p>
<h4 id="4-2-使用"><a href="#4-2-使用" class="headerlink" title="4.2 使用"></a>4.2 使用</h4><p><strong>（1）正常执行的事务</strong></p>
<p> <a href="https://i.loli.net/2020/07/19/E3uXxcygWnawbqS.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="QQ图片20200719190039.png" class="fancybox"><img alt="QQ图片20200719190039.png" title="QQ图片20200719190039.png" data-src="https://i.loli.net/2020/07/19/E3uXxcygWnawbqS.png" class="lazyload"></a></p>
<p><strong>（2）放弃事务</strong></p>
<p><a href="https://i.loli.net/2020/07/19/raXgh54vIQPVxZM.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="QQ图片20200719195632.png" class="fancybox"><img alt="QQ图片20200719195632.png" title="QQ图片20200719195632.png" data-src="https://i.loli.net/2020/07/19/raXgh54vIQPVxZM.png" class="lazyload"></a></p>
<p><strong>(3) 编写时出错和执行时出错</strong></p>
<p>  当启动事务后，在命令行编写命令时出错，会导致整个事务不能执行。</p>
<p><a href="https://i.loli.net/2020/07/19/gxMeyba9nChJ8BH.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="QQ图片20200719200903.png" class="fancybox"><img alt="QQ图片20200719200903.png" title="QQ图片20200719200903.png" data-src="https://i.loli.net/2020/07/19/gxMeyba9nChJ8BH.png" class="lazyload"></a> </p>
<p>  当启动事务后，在命令行编写命令时，命令本身没有错，但是执行报错，事务中仅错误命令执行失败，其他命令正常执行。</p>
<p><a href="https://i.loli.net/2020/07/19/viwzAXnWIHgVS8p.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="QQ图片20200719202042.png" class="fancybox"><img alt="QQ图片20200719202042.png" title="QQ图片20200719202042.png" data-src="https://i.loli.net/2020/07/19/viwzAXnWIHgVS8p.png" class="lazyload"></a></p>
<h3 id="5、缓存雪崩-穿透-降级"><a href="#5、缓存雪崩-穿透-降级" class="headerlink" title="5、缓存雪崩/穿透/降级"></a>5、缓存雪崩/穿透/降级</h3><h4 id="5-1-缓存雪崩"><a href="#5-1-缓存雪崩" class="headerlink" title="5.1 缓存雪崩"></a>5.1 缓存雪崩</h4><p>  我们可以简单的理解为：由于原有缓存失效，新缓存未到期间。例如：我们设置缓存时采用了相同的过期时间，在同一时刻出现大面积的缓存过期，所有原本应该访问缓存的请求都去查询数据库了，而对数据库CPU和内存造成巨大压力，严重的会造成数据库宕机。从而形成一系列连锁反应，造成整个系统崩溃。</p>
<p>  解决办法：</p>
<p>    大多数系统设计者考虑用加锁（ 最多的解决方案）或者队列的方式保证来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到底层存储系统上。还有一个简单方案就是将缓存失效时间分散开。</p>
<h4 id="5-2-缓存穿透"><a href="#5-2-缓存穿透" class="headerlink" title="5.2 缓存穿透"></a>5.2 缓存穿透</h4><p>  缓存穿透是指用户查询数据，在数据库没有，自然在缓存中也不会有。这样就导致用户查询的时候，在缓存中找不到，每次都要去数据库再查询一遍，然后返回空（相当于进行了两次无用的查询）。这样请求就绕过缓存直接查数据库，这也是经常提的缓存命中率问题。</p>
<p>  解决办法:</p>
<p>    最常见的则是采用布隆过滤器，将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被这个bitmap拦截掉，从而避免了对底层存储系统的查询压力。</p>
<p>    另外也有一个更为简单粗暴的方法，如果一个查询返回的数据为空（不管是数据不存在，还是系统故障），我们仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟。通过这个直接设置的默认值存放到缓存，这样第二次到缓冲中获取就有值了，而不会继续访问数据库，这种办法最简单粗暴。</p>
<h4 id="5-3-缓存预热"><a href="#5-3-缓存预热" class="headerlink" title="5.3 缓存预热"></a>5.3 缓存预热</h4><p>  缓存预热就是系统上线后，将相关的缓存数据直接加载到缓存系统。这样就可以避免在用户请求的时候，先查询数据库，然后再将数据缓存的问题！用户直接查询事先被预热的缓存数据！</p>
<p>解决思路：</p>
<p>（1）直接写个缓存刷新页面，上线时手工操作下；</p>
<p>（2）数据量不大，可以在项目启动的时候自动进行加载；</p>
<p>（3）定时刷新缓存；</p>
<p>（4）缓存更新</p>
<p>除了缓存服务器自带的缓存失效策略之外（Redis默认的有6中策略可供选择），我们还可以根据具体的业务需求进行自定义的缓存淘汰，常见的策略有两种：</p>
<p>（1）定时去清理过期的缓存；</p>
<p>（2）当有用户请求过来时，再判断这个请求所用到的缓存是否过期，过期的话就去底层系统得到新数据并更新缓存。</p>
<p>两者各有优劣，第一种的缺点是维护大量缓存的key是比较麻烦的；第二种的缺点就是每次用户请求过来都要判断缓存失效，逻辑相对比较复杂！具体用哪种方案，根据自己的应用场景来权衡。</p>
<h4 id="5-4-缓存降级"><a href="#5-4-缓存降级" class="headerlink" title="5.4 缓存降级"></a>5.4 缓存降级</h4><p>  当访问量剧增、服务出现问题（如响应时间慢或不响应）或非核心服务影响到核心流程的性能时，即使是有损服务，仍然需要保证服务还是可用的。系统可以根据一些关键数据进行自动降级，也可以配置开关实现人工降级。</p>
<p>  降级的最终目的是保证核心服务可用，即使是有损的。而且有些服务是无法降级的（如加入购物车、结算）。</p>
<p>  以参考日志级别设置预案：</p>
<p>（1）一般：比如有些服务偶尔因为网络抖动或者服务正在上线而超时，可以自动降级；</p>
<p>（2）警告：有些服务在一段时间内成功率有波动（如在95~100%之间），可以自动降级或人工降级，并发送告警；</p>
<p>（3）错误：比如可用率低于90%，或者数据库连接池被打爆了，或者访问量突然猛增到系统能承受的最大阀值，此时可以根据情况自动降级或者人工降级；</p>
<p>（4）严重错误：比如因为特殊原因数据错误了，此时需要紧急人工降级。</p>
<p>  服务降级的目的，是为了防止Redis服务故障，导致数据库跟着一起发生雪崩问题。因此，对于不重要的缓存数据，可以采取服务降级策略，例如一个比较常见的做法就是，Redis出现问题，不去数据库查询，而是直接返回默认值给用户。</p>
<h3 id="6、Redis线程安全问题"><a href="#6、Redis线程安全问题" class="headerlink" title="6、Redis线程安全问题"></a>6、Redis线程安全问题</h3><p>  我们之前说Redis是一个高并发高性能的内存数据库，那么Redis是否存在线程安全问题呢?</p>
<p>  <strong>答案是不存在</strong>。因为Redis6.0之前都是单线程的!但是利用的IO多路复用技术 + 底层是C语言实现的, 所以数据还是很快，这样就避免了线程安全问题, 保证了操作的原子性。(注意我们说的单线程是对外服务,操作数据的线程只有一个, 后台进程做备份什么的不算在内的…)</p>
<p><strong>  注意:</strong></p>
<p>  Redis6.0之后支持多线程了。但是默认不开启, 如果开启了,也会有底层的阻塞队列保证同一时刻只有一条命令被执行。所以我们不需要去考虑控制 key、vlua、事务，LPUSH/LPOP 等等的并发及线程安全问题。 </p>
<h3 id="7、Redis在项目中的应用"><a href="#7、Redis在项目中的应用" class="headerlink" title="7、Redis在项目中的应用"></a>7、Redis在项目中的应用</h3><p><a href="https://i.loli.net/2020/07/19/rY4JkNL5fFQWm26.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="1.png" class="fancybox"><img alt="1.png" title="1.png" data-src="https://i.loli.net/2020/07/19/rY4JkNL5fFQWm26.png" class="lazyload"></a></p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">cll4ac</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/08/04/redis/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/">http://yoursite.com/2020/08/04/redis/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2020/08/04/redis/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>redis/Redis学习笔记（一）</span></div></a></div></nav></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By cll4ac</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"live2d-widget-model-izumi"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>